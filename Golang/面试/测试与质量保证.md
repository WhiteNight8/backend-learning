# å•å…ƒæµ‹è¯•åŸºç¡€

## testingåŒ…çš„åŸºæœ¬ä½¿ç”¨

Goè¯­è¨€çš„æµ‹è¯•åŠŸèƒ½æ˜¯é€šè¿‡`testing`åŒ…æä¾›çš„ã€‚è¦ç¼–å†™æµ‹è¯•ï¼Œä½ éœ€è¦ï¼š

1. åˆ›å»ºä»¥`_test.go`ç»“å°¾çš„æ–‡ä»¶
2. å¯¼å…¥`testing`åŒ…
3. ç¼–å†™ä»¥`Test`å¼€å¤´çš„å‡½æ•°ï¼Œæ¥æ”¶`*testing.T`å‚æ•°

åŸºæœ¬ç¤ºä¾‹ï¼š

```go
// main.go
package main

func Add(a, b int) int {
    return a + b
}

// main_test.go
package main

import "testing"

func TestAdd(t *testing.T) {
    got := Add(2, 3)
    want := 5
    
    if got != want {
        t.Errorf("Add(2, 3) = %d; want %d", got, want)
    }
}
```

è¿è¡Œæµ‹è¯•ï¼š`go test`æˆ–`go test -v`ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰



##  æµ‹è¯•å‡½æ•°çš„å‘½åä¸ç»„ç»‡

- æµ‹è¯•å‡½æ•°å¿…é¡»ä»¥`Test`å¼€å¤´ï¼Œåè·Ÿé¦–å­—æ¯å¤§å†™çš„åç§°
- é€šå¸¸æŒ‰ç…§`Testè¢«æµ‹å‡½æ•°å`æ¥å‘½å
- å¯ä»¥ä½¿ç”¨å­æµ‹è¯•è¿›è¡Œåˆ†ç»„å’Œç»„ç»‡ï¼š

```go
func TestAdd(t *testing.T) {
    t.Run("positive numbers", func(t *testing.T) {
        if Add(2, 3) != 5 {
            t.Error("failed adding positive numbers")
        }
    })
    
    t.Run("negative numbers", func(t *testing.T) {
        if Add(-1, -2) != -3 {
            t.Error("failed adding negative numbers")
        }
    })
}
```



## åŸºæœ¬æ–­è¨€ä¸æµ‹è¯•ç»“æœéªŒè¯

Goæ ‡å‡†åº“æ²¡æœ‰æ–­è¨€åº“ï¼Œä½¿ç”¨æ¡ä»¶åˆ¤æ–­å’Œ`t.Error`/`t.Fatal`ç­‰æ–¹æ³•ï¼š

- `t.Error/Errorf`: æŠ¥å‘Šé”™è¯¯å¹¶ç»§ç»­æµ‹è¯•
- `t.Fatal/Fatalf`: æŠ¥å‘Šé”™è¯¯å¹¶ç«‹å³ç»ˆæ­¢å½“å‰æµ‹è¯•å‡½æ•°
- `t.Log/Logf`: è®°å½•ä¿¡æ¯ï¼ˆä»…åœ¨æµ‹è¯•å¤±è´¥æˆ–ä½¿ç”¨`-v`å‚æ•°æ—¶æ˜¾ç¤ºï¼‰
- `t.Skip/Skipf`: è·³è¿‡å½“å‰æµ‹è¯•

```go
func TestDivide(t *testing.T) {
    result, err := Divide(10, 2)
    
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
    
    if result != 5 {
        t.Errorf("expected 5, got %d", result)
    }
}
```



## è¡¨é©±åŠ¨æµ‹è¯•æ–¹æ³•

è¡¨é©±åŠ¨æµ‹è¯•æ˜¯Goä¸­çš„å¸¸ç”¨æ¨¡å¼ï¼Œé€‚åˆæµ‹è¯•å¤šç§è¾“å…¥å’Œé¢„æœŸè¾“å‡ºï¼š

```go
func TestAdd(t *testing.T) {
    tests := []struct {
        name     string
        a, b     int
        expected int
    }{
        {"positive", 2, 3, 5},
        {"negative", -2, -3, -5},
        {"mixed", -2, 3, 1},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got := Add(tt.a, tt.b)
            if got != tt.expected {
                t.Errorf("Add(%d, %d) = %d; want %d", tt.a, tt.b, got, tt.expected)
            }
        })
    }
}
```



##  æµ‹è¯•è¾…åŠ©å‡½æ•°çš„åˆ›å»º

è¾…åŠ©å‡½æ•°å¯ä»¥å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜æµ‹è¯•å¯è¯»æ€§ï¼š

```go
// æ£€æŸ¥é”™è¯¯çš„è¾…åŠ©å‡½æ•°
func checkError(t *testing.T, got, want error) {
    t.Helper() // æ ‡è®°ä¸ºè¾…åŠ©å‡½æ•°ï¼Œé”™è¯¯ä¼šæŠ¥å‘Šè°ƒç”¨ä½ç½®è€Œéæ­¤å‡½æ•°å†…éƒ¨
    
    if got != want {
        t.Errorf("got error %v, want %v", got, want)
    }
}

// åœ¨æµ‹è¯•ä¸­ä½¿ç”¨
func TestSomething(t *testing.T) {
    _, err := doSomething()
    checkError(t, err, nil)
}
```



## æµ‹è¯•è¦†ç›–ç‡å·¥å…·ä½¿ç”¨

Goæä¾›äº†æµ‹è¯•è¦†ç›–ç‡åˆ†æå·¥å…·ï¼š

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æ•°æ®
go test -cover

# ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out

# ä»¥HTMLæ ¼å¼æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
go tool cover -html=coverage.out
```

è¦†ç›–ç‡æŠ¥å‘Šæ˜¾ç¤ºå“ªäº›ä»£ç å·²æµ‹è¯•ï¼Œå“ªäº›æœªæµ‹è¯•ã€‚

## æµ‹è¯•çš„æœ€ä½³å®è·µä¸åŸåˆ™

1. **æµ‹è¯•åº”è¯¥æ˜¯ç‹¬ç«‹çš„**ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥èƒ½ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€

2. ä½¿ç”¨setupå’Œteardownï¼š

   ```go
   func TestMain(m *testing.M) {
       // æµ‹è¯•å‰çš„è®¾ç½®
       setup()
       
       // è¿è¡Œæµ‹è¯•
       code := m.Run()
       
       // æµ‹è¯•åçš„æ¸…ç†
       teardown()
       
       // è¿”å›é€€å‡ºç 
       os.Exit(code)
   }
   ```

3. **æµ‹è¯•è¡Œä¸ºè€Œéå®ç°**ï¼šå…³æ³¨å‡½æ•°çš„è¾“å…¥è¾“å‡ºï¼Œè€Œéå†…éƒ¨ç»†èŠ‚

4. ä½¿ç”¨`t.Parallel()`å¹¶è¡Œæµ‹è¯•ï¼šåŠ é€Ÿæµ‹è¯•æ‰§è¡Œ

   ```go
   func TestSomething(t *testing.T) {
       t.Parallel() // æ ‡è®°ä¸ºå¯å¹¶è¡Œæ‰§è¡Œ
       // ...
   }
   ```

5. ä½¿ç”¨testifyç­‰è¾…åŠ©åº“ï¼šå¯ä»¥ç®€åŒ–æ–­è¨€å’Œæµ‹è¯•å‡†å¤‡

   ```go
   import "github.com/stretchr/testify/assert"
   
   func TestAdd(t *testing.T) {
       assert.Equal(t, 5, Add(2, 3), "they should be equal")
   }
   ```

**å•å…ƒæµ‹è¯•åº”è¯¥å¿«é€Ÿ**ï¼šé¿å…ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶IOç­‰å¤–éƒ¨ä¾èµ–ï¼Œä½¿ç”¨mock

**æµ‹è¯•è¾¹ç•Œæ¡ä»¶**ï¼šç©ºå€¼ã€æé™å€¼ã€é”™è¯¯æƒ…å†µç­‰

**å°†åŸºå‡†æµ‹è¯•ä¸å•å…ƒæµ‹è¯•åˆ†å¼€**ï¼šä½¿ç”¨`Benchmark`å‰ç¼€ç¼–å†™åŸºå‡†æµ‹è¯•



# æµ‹è¯•è¿›é˜¶æŠ€å·§

## åŸºå‡†æµ‹è¯•(Benchmark)çš„ç¼–å†™ä¸è¿è¡Œ

åŸºå‡†æµ‹è¯•ç”¨äºæµ‹é‡ä»£ç æ€§èƒ½ï¼Œä»¥`Benchmark`ä¸ºå‰ç¼€ï¼Œæ¥æ”¶`*testing.B`å‚æ•°ï¼š

```go
func BenchmarkAdd(b *testing.B) {
    // b.Nç”±æµ‹è¯•æ¡†æ¶æ§åˆ¶ï¼Œä¼šè‡ªåŠ¨è°ƒæ•´ä»¥è·å–ç¨³å®šçš„æ€§èƒ½æ•°æ®
    for i := 0; i < b.N; i++ {
        Add(2, 3)
    }
}
```

è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=.

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
go test -bench=BenchmarkAdd

# è¯¦ç»†çš„å†…å­˜åˆ†é…ç»Ÿè®¡
go test -bench=. -benchmem

# æ§åˆ¶è¿è¡Œæ—¶é—´ï¼ˆé»˜è®¤1ç§’ï¼‰
go test -bench=. -benchtime=5s
```

åŸºå‡†æµ‹è¯•è¿›é˜¶æŠ€å·§ï¼š

```go
func BenchmarkComplexOperation(b *testing.B) {
    // é‡ç½®è®¡æ—¶å™¨ï¼Œé¿å…åˆå§‹åŒ–ä»£ç å½±å“æµ‹é‡
    data := prepareTestData()
    b.ResetTimer()
    
    // å¹¶è¡ŒåŸºå‡†æµ‹è¯•
    b.RunParallel(func(pb *testing.PB) {
        for pb.Next() {
            ComplexOperation(data)
        }
    })
}
```



## å­æµ‹è¯•ä¸æµ‹è¯•ç»„ç»‡

ä½¿ç”¨å­æµ‹è¯•å¯ä»¥æ›´å¥½åœ°ç»„ç»‡æµ‹è¯•ç”¨ä¾‹ï¼Œä¾¿äºç­›é€‰å’Œå¹¶è¡Œæ‰§è¡Œï¼š

```go
func TestParser(t *testing.T) {
    tests := map[string]struct {
        input    string
        expected Result
        err      error
    }{
        "simple": {
            input:    "simple input",
            expected: Result{Value: "simple"},
            err:      nil,
        },
        "complex": {
            input:    "complex input",
            expected: Result{Value: "complex"},
            err:      nil,
        },
        "error": {
            input:    "invalid",
            expected: Result{},
            err:      ErrInvalidInput,
        },
    }
    
    for name, tc := range tests {
        t.Run(name, func(t *testing.T) {
            // å¯ä»¥åœ¨å­æµ‹è¯•ä¸­å¼€å¯å¹¶è¡Œ
            t.Parallel()
            
            result, err := Parse(tc.input)
            
            if !errors.Is(err, tc.err) {
                t.Fatalf("expected error %v, got %v", tc.err, err)
            }
            
            if result != tc.expected {
                t.Errorf("expected %v, got %v", tc.expected, result)
            }
        })
    }
}
```

è¿è¡Œç‰¹å®šå­æµ‹è¯•ï¼š

```bash
go test -run=TestParser/simple
```





##  HTTPæµ‹è¯•ä¸æœåŠ¡æ¨¡æ‹Ÿ

Goæ ‡å‡†åº“æä¾›äº†å¼ºå¤§çš„HTTPæµ‹è¯•å·¥å…·ï¼š

```go
import (
    "net/http"
    "net/http/httptest"
    "testing"
)

func TestHandler(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•è¯·æ±‚
    req, err := http.NewRequest("GET", "/api/items?id=123", nil)
    if err != nil {
        t.Fatal(err)
    }
    
    // åˆ›å»ºå“åº”è®°å½•å™¨
    rr := httptest.NewRecorder()
    
    // åˆ›å»ºå¤„ç†å™¨å¹¶å¤„ç†è¯·æ±‚
    handler := http.HandlerFunc(YourHandler)
    handler.ServeHTTP(rr, req)
    
    // æ£€æŸ¥çŠ¶æ€ç 
    if status := rr.Code; status != http.StatusOK {
        t.Errorf("handler returned wrong status code: got %v want %v", 
                  status, http.StatusOK)
    }
    
    // æ£€æŸ¥å“åº”ä½“
    expected := `{"status":"ok"}`
    if rr.Body.String() != expected {
        t.Errorf("handler returned unexpected body: got %v want %v",
                  rr.Body.String(), expected)
    }
}
```

æµ‹è¯•æ•´ä¸ªæœåŠ¡ï¼š

```go
// åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨
server := httptest.NewServer(YourRouter())
defer server.Close()

// ä½¿ç”¨å®¢æˆ·ç«¯æµ‹è¯•
client := server.Client()
resp, err := client.Get(server.URL + "/api/items")
```



## æ¨¡æ‹Ÿä¸æ¡©(Stub)çš„åŸºæœ¬å®ç°

åœ¨Goä¸­å®ç°æ¨¡æ‹Ÿä¸»è¦é€šè¿‡æ¥å£å’Œä¾èµ–æ³¨å…¥ï¼š

```go
// å®šä¹‰æ¥å£
type DataStore interface {
    GetUser(id string) (User, error)
    SaveUser(user User) error
}

// å®ç°æ¨¡æ‹Ÿç‰ˆæœ¬
type MockDataStore struct {
    users map[string]User
    // è·Ÿè¸ªè°ƒç”¨
    GetUserCalls int
}

func NewMockDataStore() *MockDataStore {
    return &MockDataStore{
        users: make(map[string]User),
    }
}

func (m *MockDataStore) GetUser(id string) (User, error) {
    m.GetUserCalls++
    user, ok := m.users[id]
    if !ok {
        return User{}, ErrUserNotFound
    }
    return user, nil
}

func (m *MockDataStore) SaveUser(user User) error {
    m.users[user.ID] = user
    return nil
}

// æµ‹è¯•ä½¿ç”¨æ¨¡æ‹Ÿ
func TestUserService_GetUser(t *testing.T) {
    mock := NewMockDataStore()
    
    // é¢„è®¾æ•°æ®
    mock.users["123"] = User{ID: "123", Name: "Test User"}
    
    // ä½¿ç”¨æ¨¡æ‹Ÿçš„ä¾èµ–æ³¨å…¥
    service := NewUserService(mock)
    
    // æµ‹è¯•
    user, err := service.GetUser("123")
    
    // éªŒè¯ç»“æœ
    if err != nil {
        t.Fatalf("expected no error, got %v", err)
    }
    if user.Name != "Test User" {
        t.Errorf("expected 'Test User', got %s", user.Name)
    }
    
    // éªŒè¯è°ƒç”¨æ¬¡æ•°
    if mock.GetUserCalls != 1 {
        t.Errorf("expected 1 call to GetUser, got %d", mock.GetUserCalls)
    }
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚`gomock`æˆ–`testify/mock`æ¥ç®€åŒ–æ¨¡æ‹Ÿï¼š

```go
// ä½¿ç”¨testify/mock
import "github.com/stretchr/testify/mock"

type MockDataStore struct {
    mock.Mock
}

func (m *MockDataStore) GetUser(id string) (User, error) {
    args := m.Called(id)
    return args.Get(0).(User), args.Error(1)
}

// æµ‹è¯•
func TestUserService(t *testing.T) {
    mockStore := new(MockDataStore)
    
    // è®¾ç½®æœŸæœ›
    mockStore.On("GetUser", "123").Return(User{ID: "123", Name: "Test"}, nil)
    
    service := NewUserService(mockStore)
    user, _ := service.GetUser("123")
    
    // éªŒè¯æœŸæœ›è¢«æ»¡è¶³
    mockStore.AssertExpectations(t)
}
```



## æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥

ä¾èµ–æ³¨å…¥æ˜¯å®ç°å¯æµ‹è¯•ä»£ç çš„å…³é”®ï¼š

```go
// ä¸å¥½çš„ä¾‹å­ï¼šç¡¬ç¼–ç ä¾èµ–
type UserService struct {}

func (s *UserService) GetUser(id string) (User, error) {
    // ç›´æ¥ä¾èµ–äºå…¨å±€æ•°æ®åº“è¿æ¥
    return database.GetUser(id)
}

// å¥½çš„ä¾‹å­ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥
type UserService struct {
    store DataStore // ä¾èµ–æ¥å£è€Œéå…·ä½“å®ç°
}

func NewUserService(store DataStore) *UserService {
    return &UserService{store: store}
}

func (s *UserService) GetUser(id string) (User, error) {
    return s.store.GetUser(id)
}
```

æµ‹è¯•æ—¶å¯ä»¥è½»æ¾æ³¨å…¥æ¨¡æ‹Ÿä¾èµ–ï¼š

```go
func TestUserService(t *testing.T) {
    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®å®ç°
    // service := NewUserService(postgres.NewDataStore())
    
    // æµ‹è¯•ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿ
    mockStore := NewMockDataStore()
    service := NewUserService(mockStore)
    
    // æµ‹è¯•...
}
```



## å¹¶è¡Œæµ‹è¯•æ‰§è¡Œä¸ç«äº‰æ£€æµ‹

### å¹¶è¡Œæµ‹è¯•

```go
func TestSomething(t *testing.T) {
    t.Parallel() // æ ‡è®°è¯¥æµ‹è¯•å¯å¹¶è¡Œæ‰§è¡Œ
    
    // å­æµ‹è¯•ä¹Ÿå¯ä»¥å¹¶è¡Œ
    t.Run("subtest", func(t *testing.T) {
        t.Parallel()
        // ...
    })
}
```

è¿è¡Œæ—¶æ§åˆ¶å¹¶è¡Œåº¦ï¼š

```bash
# è®¾ç½®æœ€å¤§å¹¶è¡Œæµ‹è¯•æ•°
go test -parallel 4
```

### ç«äº‰æ£€æµ‹

Goå†…ç½®äº†ç«äº‰æ£€æµ‹å™¨ï¼Œå¯ä»¥å‘ç°æ½œåœ¨çš„æ•°æ®ç«äº‰ï¼š

```bash
# å¼€å¯ç«äº‰æ£€æµ‹è¿è¡Œæµ‹è¯•
go test -race

# ç»“åˆè¦†ç›–ç‡å’Œç«äº‰æ£€æµ‹
go test -race -cover
```

ç¼–å†™ä¸“é—¨çš„ç«äº‰æµ‹è¯•ï¼š

```go
func TestConcurrentAccess(t *testing.T) {
    counter := NewCounter()
    wg := sync.WaitGroup{}
    
    // åˆ›å»ºå¤šä¸ªgoroutineåŒæ—¶è®¿é—®counter
    for i := 0; i < 1000; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            counter.Increment()
        }()
    }
    
    wg.Wait()
    
    // éªŒè¯ç»“æœ
    if counter.Value() != 1000 {
        t.Errorf("expected 1000, got %d", counter.Value())
    }
}
```



## æµ‹è¯•æ¸…ç†ä¸èµ„æºç®¡ç†

åˆç†ç®¡ç†æµ‹è¯•èµ„æºå¯é˜²æ­¢æ³„æ¼å’Œä¾èµ–é—®é¢˜ï¼š

### ä½¿ç”¨`t.Cleanup`æ³¨å†Œæ¸…ç†å‡½æ•°

```go
func TestWithResource(t *testing.T) {
    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    tmpfile, err := os.CreateTemp("", "test")
    if err != nil {
        t.Fatal(err)
    }
    
    // æ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œå³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¼šæ‰§è¡Œ
    t.Cleanup(func() {
        tmpfile.Close()
        os.Remove(tmpfile.Name())
    })
    
    // ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è¿›è¡Œæµ‹è¯•...
}
```

### ä½¿ç”¨`TestMain`è¿›è¡Œå…¨å±€è®¾ç½®å’Œæ¸…ç†

```go
var db *sql.DB

func TestMain(m *testing.M) {
    // å…¨å±€è®¾ç½®
    var err error
    db, err = sql.Open("sqlite3", ":memory:")
    if err != nil {
        log.Fatalf("Cannot connect to DB: %v", err)
    }
    
    // è¿è¡Œæµ‹è¯•
    code := m.Run()
    
    // å…¨å±€æ¸…ç†
    db.Close()
    
    // å°†æµ‹è¯•è¿è¡ŒçŠ¶æ€è¿”å›ç»™go testå‘½ä»¤
    os.Exit(code)
}
```

### æ•°æ®åº“é›†æˆæµ‹è¯•çš„æ¸…ç†æ¨¡å¼

```go
func TestDatabase(t *testing.T) {
    // è·³è¿‡é›†æˆæµ‹è¯•ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if testing.Short() {
        t.Skip("skipping integration test in short mode")
    }
    
    // è®¾ç½®æµ‹è¯•æ•°æ®åº“
    db, err := setupTestDB()
    if err != nil {
        t.Fatal(err)
    }
    
    // æ³¨å†Œæ¸…ç†
    t.Cleanup(func() {
        teardownTestDB(db)
    })
    
    // ä½¿ç”¨äº‹åŠ¡éš”ç¦»æµ‹è¯•
    t.Run("transaction test", func(t *testing.T) {
        tx, err := db.Begin()
        if err != nil {
            t.Fatal(err)
        }
        
        t.Cleanup(func() {
            tx.Rollback() // æµ‹è¯•åå›æ»šï¼Œé¿å…çŠ¶æ€æ±¡æŸ“
        })
        
        // ä½¿ç”¨äº‹åŠ¡è¿›è¡Œæµ‹è¯•...
    })
}
```





# Goä»£ç è´¨é‡å·¥å…·

## golintä¸golangci-lintçš„ä½¿ç”¨

### golint

`golint`æ˜¯ä¸€ä¸ªæ£€æŸ¥Goä»£ç é£æ ¼çš„å·¥å…·ï¼Œä½†ç›®å‰å·²è¢«å¼ƒç”¨ï¼Œæ¨èä½¿ç”¨`staticcheck`æˆ–`golangci-lint`ã€‚

å®‰è£…ä¸ä½¿ç”¨ï¼ˆä»…ä½œå‚è€ƒï¼‰ï¼š

```bash
go install golang.org/x/lint/golint@latest
golint ./...
```

### golangci-lint

`golangci-lint`æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„Go lintersè¿è¡Œå™¨ï¼Œæ•´åˆäº†å¤šç§ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·ã€‚

å®‰è£…ï¼š

```bash
# äºŒè¿›åˆ¶å®‰è£…ï¼ˆæ¨èï¼‰
curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin

# æˆ–é€šè¿‡Goå®‰è£…
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
```

åŸºæœ¬ä½¿ç”¨ï¼š

```bash
# è¿è¡Œé»˜è®¤linters
golangci-lint run

# æŒ‡å®šç›®å½•
golangci-lint run ./pkg/... ./cmd/...

# è¿è¡Œç‰¹å®šlinter
golangci-lint run --enable=gosimple,govet,gofmt
```

é…ç½®æ–‡ä»¶ï¼ˆ`.golangci.yml`ï¼‰ï¼š

```yaml
linters:
  enable:
    - errcheck      # æ£€æŸ¥é”™è¯¯å¤„ç†
    - gosimple      # ç®€åŒ–ä»£ç å»ºè®®
    - govet         # æŠ¥å‘Šå¯ç–‘æ„é€ 
    - staticcheck   # é™æ€åˆ†ææ£€æŸ¥
    - unused        # æœªä½¿ç”¨çš„ä»£ç æ£€æŸ¥
    - gofmt         # æ ¼å¼æ£€æŸ¥
    - goimports     # å¯¼å…¥æ ¼å¼æ£€æŸ¥
    - gocyclo       # å¾ªç¯å¤æ‚åº¦æ£€æŸ¥
    - misspell      # æ‹¼å†™æ£€æŸ¥
    - revive        # ä»£ç é£æ ¼æ£€æŸ¥
  disable:
    - lll           # è¡Œé•¿åº¦æ£€æŸ¥

# å„linteré…ç½®
linters-settings:
  gocyclo:
    min-complexity: 15  # é»˜è®¤ä¸º30
  govet:
    check-shadowing: true
  golint:
    min-confidence: 0.8

# é—®é¢˜ä¸¥é‡çº§åˆ«è®¾ç½®
issues:
  exclude-rules:
    - path: _test\.go
      linters:
        - gocyclo
        - dupl
```

CIé›†æˆï¼š

```yaml
# GitHub Actionsç¤ºä¾‹
name: golangci-lint
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
```



## go veté™æ€åˆ†æå·¥å…·

`go vet`æ˜¯Goæ ‡å‡†å·¥å…·é“¾çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ£€æŸ¥æºä»£ç ä¸­å¯èƒ½çš„é”™è¯¯ã€‚

åŸºæœ¬ä½¿ç”¨ï¼š

```bash
# æ£€æŸ¥å½“å‰åŒ…
go vet

# æ£€æŸ¥æ‰€æœ‰åŒ…
go vet ./...

# æ£€æŸ¥ç‰¹å®šåŒ…
go vet github.com/user/project/pkg/...
```

`go vet`å¯ä»¥æ£€æŸ¥çš„é—®é¢˜ç±»å‹ï¼š

- æ‰“å°æ ¼å¼ä¸åŒ¹é…ï¼ˆfmté”™è¯¯ï¼‰
- æ–¹æ³•ç­¾åä¸åŒ¹é…
- ç»“æ„ä½“æ ‡ç­¾ä¸è§„èŒƒ
- æ— æ•ˆçš„é”™è¯¯è¿”å›
- æœªä½¿ç”¨çš„ç»“æœ
- å¯ç–‘çš„èµ‹å€¼
- æœªä½¿ç”¨çš„å‚æ•°
- æ— æ³•åˆ°è¾¾çš„ä»£ç 

ç¤ºä¾‹é”™è¯¯æ£€æµ‹ï¼š

```go
func example() {
    var x int
    fmt.Printf("%s", x)     // go vetä¼šæŠ¥å‘Šæ ¼å¼ä¸åŒ¹é…
    
    var err error
    if err == nil {
        fmt.Println("no error")
        return
        fmt.Println("unreachable") // go vetä¼šæŠ¥å‘Šä¸å¯è¾¾ä»£ç 
    }
}
```



## gofmtä¸goimportsä»£ç æ ¼å¼åŒ–

### gofmt

`gofmt`æ˜¯Goæ ‡å‡†å·¥å…·ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–Goä»£ç ã€‚

ä½¿ç”¨ï¼š

```bash
# æŸ¥çœ‹æ ¼å¼åŒ–åçš„ä»£ç ï¼ˆä¸ä¿®æ”¹æ–‡ä»¶ï¼‰
gofmt file.go

# æ ¼å¼åŒ–å¹¶è¦†ç›–åŸæ–‡ä»¶
gofmt -w file.go

# é€’å½’æ ¼å¼åŒ–ç›®å½•
gofmt -w ./...

# æ›´ç®€åŒ–çš„æ ¼å¼
gofmt -s -w file.go
```

### goimports

`goimports`åœ¨`gofmt`åŸºç¡€ä¸Šå¢åŠ äº†è‡ªåŠ¨ç®¡ç†å¯¼å…¥åŒ…çš„åŠŸèƒ½ã€‚

å®‰è£…ä¸ä½¿ç”¨ï¼š

```bash
go install golang.org/x/tools/cmd/goimports@latest

# æ ¼å¼åŒ–å•ä¸ªæ–‡ä»¶
goimports -w file.go

# é€’å½’æ ¼å¼åŒ–ç›®å½•
goimports -w ./
```

IDEé›†æˆï¼š

- VSCode: ä½¿ç”¨Goæ‰©å±•ï¼Œè®¾ç½®`"go.formatTool": "goimports"`å’Œ`"editor.formatOnSave": true`
- GoLand: åœ¨è®¾ç½®ä¸­å¯ç”¨"On save"ä¸‹çš„"Run goimports"

Gité’©å­é›†æˆï¼š

```bash
#!/bin/sh
# ä¿å­˜ä¸º.git/hooks/pre-commitå¹¶æ·»åŠ æ‰§è¡Œæƒé™

STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.go$")
if [[ "$STAGED_GO_FILES" = "" ]]; then
  exit 0
fi

for FILE in $STAGED_GO_FILES
do
  goimports -w $FILE
  git add $FILE
done
```



## åœˆå¤æ‚åº¦æ£€æµ‹ä¸ä»£ç è´¨é‡åº¦é‡

### åœˆå¤æ‚åº¦æ£€æµ‹

åœˆå¤æ‚åº¦æ˜¯è¡¡é‡ä»£ç åˆ†æ”¯ç»“æ„å¤æ‚ç¨‹åº¦çš„æŒ‡æ ‡ï¼Œä½¿ç”¨`gocyclo`å·¥å…·æ£€æµ‹ï¼š

```bash
go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

# æ˜¾ç¤ºå¤æ‚åº¦è¶…è¿‡15çš„å‡½æ•°
gocyclo -over 15 .

# æŒ‰å¤æ‚åº¦é™åºæ’åˆ—
gocyclo -top 10 .
```

é«˜å¤æ‚åº¦ç¤ºä¾‹ï¼ˆåº”å½“é‡æ„ï¼‰ï¼š

```go
func complexFunction(input int) string {
    if input < 0 {
        if input < -10 {
            return "very negative"
        } else if input < -5 {
            return "moderately negative"
        } else {
            return "slightly negative"
        }
    } else if input > 0 {
        if input > 10 {
            return "very positive"
        } else if input > 5 {
            return "moderately positive"
        } else {
            return "slightly positive"
        }
    } else {
        return "zero"
    }
}
```

### ä»£ç è´¨é‡åº¦é‡

Goè´¨é‡æŠ¥å‘Šå·¥å…·`goreportcard`ï¼š

```bash
go install github.com/gojp/goreportcard/cmd/goreportcard-cli@latest
goreportcard-cli -v
```

å…¨é¢çš„ä»£ç è´¨é‡æŒ‡æ ‡ï¼š

- æµ‹è¯•è¦†ç›–ç‡ï¼š`go test -cover ./...`
- ä»£ç è¡Œæ•°ï¼š`cloc .`æˆ–`scc .`ï¼ˆéœ€è¦å•ç‹¬å®‰è£…ï¼‰
- æ¥å£ç¨³å®šæ€§ï¼š`go-stability`ï¼ˆéœ€è¦å•ç‹¬å®‰è£…ï¼‰

åœ¨çº¿æœåŠ¡ï¼š

- [Go Report Card](https://goreportcard.com/)
- [CodeClimate](https://codeclimate.com/)
- [SonarQube](https://www.sonarqube.org/)



## å¸¸è§ä»£ç å¼‚å‘³ä¸é‡æ„æŠ€å·§

### å¸¸è§ä»£ç å¼‚å‘³

1. è¿‡é•¿å‡½æ•°ï¼šå‡½æ•°è¶…è¿‡50-100è¡Œ

   ```go
   // é‡æ„å‰ï¼šä¸€ä¸ªå·¨å¤§çš„å‡½æ•°åšå¤šä»¶äº‹
   func ProcessOrder(order Order) error {
       // éªŒè¯è®¢å• (30è¡Œ)
       // ...
       
       // æ›´æ–°åº“å­˜ (40è¡Œ)
       // ...
       
       // æ”¯ä»˜å¤„ç† (50è¡Œ)
       // ...
       
       // å‘é€é€šçŸ¥ (30è¡Œ)
       // ...
       
       return nil
   }
   
   // é‡æ„åï¼šæ‹†åˆ†ä¸ºå¤šä¸ªå‡½æ•°
   func ProcessOrder(order Order) error {
       if err := ValidateOrder(order); err != nil {
           return err
       }
       
       if err := UpdateInventory(order); err != nil {
           return err
       }
       
       if err := ProcessPayment(order); err != nil {
           return err
       }
       
       return SendNotification(order)
   }
   ```

2. è¿‡æ·±åµŒå¥—ï¼šå¤šå±‚if-elseæˆ–å¾ªç¯åµŒå¥—

   ```go
   // é‡æ„å‰ï¼šæ·±åº¦åµŒå¥—
   func processData(data []Item) {
       if len(data) > 0 {
           for _, item := range data {
               if item.IsValid() {
                   if item.Value > 10 {
                       // å¤„ç†é€»è¾‘
                   }
               }
           }
       }
   }
   
   // é‡æ„åï¼šæ—©è¿”å›
   func processData(data []Item) {
       if len(data) == 0 {
           return
       }
       
       for _, item := range data {
           if !item.IsValid() {
               continue
           }
           
           if item.Value <= 10 {
               continue
           }
           
           // å¤„ç†é€»è¾‘
       }
   }
   ```

3. é”™è¯¯å¤„ç†åæ¨¡å¼ï¼š

   

   ```go
   // é‡æ„å‰ï¼šé”™è¯¯å¤„ç†å æ®ä¸»é€»è¾‘
   func doSomething() error {
       result1, err := step1()
       if err != nil {
           return err
       }
       
       result2, err := step2(result1)
       if err != nil {
           return err
       }
       
       result3, err := step3(result2)
       if err != nil {
           return err
       }
       
       return step4(result3)
   }
   
   // é‡æ„åï¼šä½¿ç”¨é”™è¯¯å¤„ç†å‡½æ•°
   func doSomething() (err error) {
       var result1 Result1
       var result2 Result2
       
       // handleErrorä¼šåœ¨errénilæ—¶è¿”å›true
       if result1, err = step1(); handleError(&err) {
           return
       }
       
       if result2, err = step2(result1); handleError(&err) {
           return
       }
       
       var result3 Result3
       if result3, err = step3(result2); handleError(&err) {
           return
       }
       
       return step4(result3)
   }
   
   func handleError(err *error) bool {
       return *err != nil
   }
   ```

4. å¯å˜å…¨å±€çŠ¶æ€ï¼šæ»¥ç”¨å…¨å±€å˜é‡

   ```go
   // é‡æ„å‰ï¼šä½¿ç”¨å…¨å±€å˜é‡
   var globalConfig Config
   
   func LoadConfig() {
       // åŠ è½½å…¨å±€é…ç½®
   }
   
   func UseConfig() {
       // ä½¿ç”¨å…¨å±€é…ç½®
   }
   
   // é‡æ„åï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥
   type Service struct {
       config Config
   }
   
   func NewService(config Config) *Service {
       return &Service{config: config}
   }
   
   func (s *Service) DoWork() {
       // ä½¿ç”¨s.config
   }
   ```

### é‡æ„æŠ€å·§

1. **æå–å‡½æ•°**ï¼šå°†ä¸€ç»„ç›¸å…³ä»£ç æå–ä¸ºç‹¬ç«‹å‡½æ•°
2. **å‚æ•°å¯¹è±¡**ï¼šå¤šä¸ªå‚æ•°ç»„åˆä¸ºç»“æ„ä½“
3. **æ–¹æ³•å¯¹è±¡**ï¼šå°†å¤§å‹æ–¹æ³•è½¬å˜ä¸ºè‡ªå·±çš„ç±»
4. **ç”¨å¤šæ€æ›¿ä»£æ¡ä»¶**ï¼šç”¨æ¥å£å’Œå®ç°æ›¿ä»£å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
5. **æå–æ¥å£**ï¼šä»å®ç°ä¸­æŠ½è±¡å‡ºæ¥å£
6. **åŠŸèƒ½åˆ†å±‚**ï¼šæ¸…æ™°åˆ’åˆ†èŒè´£è¾¹ç•Œ



## ä»£ç å®¡æŸ¥æœ€ä½³å®è·µ

### æŠ€æœ¯æ–¹é¢

1. å…³æ³¨ç‚¹ï¼š
   - ä»£ç æ­£ç¡®æ€§ï¼šåŠŸèƒ½æ˜¯å¦ç¬¦åˆéœ€æ±‚
   - é”™è¯¯å¤„ç†ï¼šæ˜¯å¦æ¶µç›–æ‰€æœ‰é”™è¯¯æƒ…å†µ
   - æµ‹è¯•è¦†ç›–ï¼šæ˜¯å¦æœ‰å……åˆ†æµ‹è¯•
   - æ€§èƒ½ï¼šæ˜¯å¦æœ‰æ˜æ˜¾æ€§èƒ½é—®é¢˜
   - å¹¶å‘å®‰å…¨ï¼šæ˜¯å¦å­˜åœ¨æ•°æ®ç«äº‰
   - ä»£ç é£æ ¼ï¼šæ˜¯å¦ç¬¦åˆé¡¹ç›®è§„èŒƒ
2. è‡ªåŠ¨åŒ–æ£€æŸ¥ï¼š
   - ä½¿ç”¨CIé›†æˆé™æ€åˆ†æå·¥å…·
   - è‡ªåŠ¨è¿è¡Œæµ‹è¯•å’Œè¦†ç›–ç‡æŠ¥å‘Š
   - ä½¿ç”¨ä»£ç è§„èŒƒæ£€æŸ¥å·¥å…·
3. å…·ä½“æ£€æŸ¥æ¸…å•ï¼š
   - é”™è¯¯å¤„ç†æ˜¯å¦å®Œæ•´
   - æ˜¯å¦æœ‰èµ„æºæ³„æ¼ï¼ˆæœªå…³é—­æ–‡ä»¶ã€è¿æ¥ç­‰ï¼‰
   - å¹¶å‘ä»£ç æ˜¯å¦å®‰å…¨
   - å‘½åæ˜¯å¦æ¸…æ™°ã€ä¸€è‡´
   - æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ³¨é‡Š
   - æµ‹è¯•æ˜¯å¦å…¨é¢ä¸”æœ‰æ„ä¹‰

### æµç¨‹æ–¹é¢

1. **é€‚å½“è§„æ¨¡**ï¼šæ¯æ¬¡å®¡æŸ¥æ§åˆ¶åœ¨200-400è¡Œä»£ç 
2. **åŠæ—¶åé¦ˆ**ï¼š24å°æ—¶å†…ç»™å‡ºåé¦ˆ
3. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šåˆ†é˜¶æ®µå®¡æŸ¥ï¼ˆæ¶æ„â†’å®ç°â†’æµ‹è¯•ï¼‰
4. **ä½¿ç”¨å·¥å…·**ï¼šGitHub PRã€Gerritã€ReviewBoardç­‰
5. **æ£€æŸ¥æ¸…å•**ï¼šä¸ºå¸¸è§é—®é¢˜ç»´æŠ¤æ£€æŸ¥æ¸…å•

ç¤ºä¾‹GitHub Actionså·¥ä½œæµï¼š

```yaml
name: Code Review

on:
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: golangci/golangci-lint-action@v3
  
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - run: go test -v -race -coverprofile=coverage.txt ./...
      - uses: codecov/codecov-action@v3
```

### æ²Ÿé€šæ–¹é¢

1. **æœ‰å»ºè®¾æ€§**ï¼šæä¾›è§£å†³æ–¹æ¡ˆï¼Œä¸ä»…ä»…æŒ‡å‡ºé—®é¢˜
2. **é¿å…ä¸»è§‚åˆ¤æ–­**ï¼šä½¿ç”¨å®¢è§‚æ ‡å‡†è€Œéä¸ªäººå–œå¥½
3. **é—®é¢˜åˆ†ç±»**ï¼šåŒºåˆ†å¿…é¡»ä¿®å¤å’Œå»ºè®®æ”¹è¿›
4. **èµç¾ä¼˜ç‚¹**ï¼šè‚¯å®šä»£ç ä¸­åšå¾—å¥½çš„éƒ¨åˆ†

ç¤ºä¾‹åé¦ˆï¼š

```
âœ… **åšå¾—å¥½**:
- é”™è¯¯å¤„ç†éå¸¸å…¨é¢
- æµ‹è¯•è¦†ç›–äº†è¾¹ç¼˜æƒ…å†µ

â— **å¿…é¡»ä¿®æ”¹**:
- `processItem`å‡½æ•°æœªæ£€æŸ¥ç©ºæŒ‡é’ˆï¼Œå¯èƒ½å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸
- æœªé‡Šæ”¾çš„èµ„æºï¼šç¬¬45è¡Œæ‰“å¼€çš„æ–‡ä»¶æ²¡æœ‰å…³é—­

ğŸ’¡ **å»ºè®®**:
- è€ƒè™‘ä½¿ç”¨`sync.Pool`å‡å°‘å†…å­˜åˆ†é…
- å‡½æ•°`calculateTotal`å¤æ‚åº¦è¾ƒé«˜ï¼Œå»ºè®®æ‹†åˆ†
```



## Goæ¨¡å—å®‰å…¨å®¡è®¡å·¥å…·

### ä¾èµ–æ‰«æ

**Goæ¼æ´æ£€æŸ¥å·¥å…·(govulncheck)**ï¼š

```bash
go install golang.org/x/vuln/cmd/govulncheck@latest

# æ£€æŸ¥å½“å‰æ¨¡å—
govulncheck ./...

# æ£€æŸ¥ç‰¹å®šåŒ…
govulncheck ./pkg/...
```

**Nancy**ï¼šç”¨äºæ£€æŸ¥Goä¾èµ–ä¸­çš„å·²çŸ¥æ¼æ´

```bash
go install github.com/sonatype-nexus-community/nancy@latest

# æ£€æŸ¥ä¾èµ–
go list -json -m all | nancy sleuth
```

### ä¾èµ–ç®¡ç†ä¸å®¡è®¡

**go mod tidy**ï¼šæ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–

```bash
go mod tidy
```

**go mod verify**ï¼šéªŒè¯ä¾èµ–çš„å®Œæ•´æ€§

```bash
go mod verify
```

**go mod why**ï¼šè§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æŸä¸ªä¾èµ–

```bash
go mod why -m github.com/some/dependency
```

**go list**ï¼šæŸ¥çœ‹æ‰€æœ‰ä¾èµ–

```bash
# åˆ—å‡ºæ‰€æœ‰ä¾èµ–
go list -m all

# è¯¦ç»†ä¾èµ–ä¿¡æ¯
go list -m -json all
```

### å®‰å…¨å®è·µ

1. **ç‰ˆæœ¬é”å®š**ï¼šä½¿ç”¨`go.mod`é”å®šä¾èµ–ç‰ˆæœ¬
2. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸè¿è¡Œ`go get -u`æ›´æ–°ä¾èµ–
3. **ä¾èµ–å®¡è®¡**ï¼šä½¿ç”¨`govulncheck`å®šæœŸæ£€æŸ¥æ¼æ´
4. **æœ€å°åŒ–ä¾èµ–**ï¼šå‡å°‘ä¸å¿…è¦çš„ä¾èµ–
5. **ä¾›åº”é“¾å®‰å…¨**ï¼šè€ƒè™‘ä½¿ç”¨`vendor`ç›®å½•ï¼ˆ`go mod vendor`ï¼‰

CIé›†æˆç¤ºä¾‹ï¼š

```yaml
name: Security Scan

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨è¿è¡Œ

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      
      - name: Check vulnerabilities
        run: govulncheck ./...
      
      - name: Verify dependencies
        run: go mod verify
```

### ä¾›åº”å•†å®¡è®¡

å¯¹äºå…³é”®åº”ç”¨ï¼Œè€ƒè™‘å®ç°æ›´ä¸¥æ ¼çš„ä¾èµ–æ§åˆ¶ï¼š

1. **ä¾èµ–ç™½åå•**ï¼šç»´æŠ¤å·²å®¡è®¡ä¾èµ–çš„åˆ—è¡¨
2. **ä¾èµ–ä½¿ç”¨ç­–ç•¥**ï¼šä»…ä½¿ç”¨æ ¸å¿ƒå’Œå¿…è¦çš„ä¾èµ–
3. **ä¾èµ–æ›´æ–°æµç¨‹**ï¼šå»ºç«‹æ­£å¼çš„ä¾èµ–æ›´æ–°å’Œå®¡è®¡æµç¨‹
4. **æˆç†Ÿåº¦è¯„ä¼°**ï¼šè¯„ä¼°ä¾èµ–çš„æˆç†Ÿåº¦å’Œç¤¾åŒºæ´»è·ƒåº¦
